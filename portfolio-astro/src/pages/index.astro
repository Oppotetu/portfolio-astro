---
import Gallery from '@/components/Gallery.astro';
import Layout from '@/layouts/Layout.astro';
import type { ImageEntry } from '@/lib/types';
import type { Project } from '@/lib/types';
import { sanityClient } from 'sanity:client';

let projects: Project[] = await sanityClient.fetch(
  `*[_type == "project"]{
    'slug': slug.current, 
    title, 
    authors,
    summary,
    squareFootage,
    publishedAt,
    assignmentType
  }`
);

const imageModules: Record<string, string> = import.meta.glob(
  '../images/**/*.{jpg,jpeg,png,webp}',
  {
    eager: true,
    query: '?url',
    import: 'default',
  }
);

const imageEntries = Object.entries(imageModules);

let images: ImageEntry[] = [];
let projectCounter: string;

for (let i = 0; i < imageEntries.length; i++) {
  const path = imageEntries[i][0];

  const projectAndFile = path.split('/images/')[1];
  const project = projectAndFile.split('/')[0];

  if (!projectCounter || projectCounter !== project) {
    projects = projects?.map((p) =>
      p.slug === project ? { ...p, slideIndexStart: i } : p
    );
    projectCounter = project;
  }

  const projectFromCms = projects?.find((p) => p.slug === project);
  images.push({
    project: project,
    filename: projectAndFile.split('/')[1],
    filepath: imageModules[path],
    carouselIndex: i,
    // title: projectFromCms?.title,
    // authors: projectFromCms?.authors,
    // oppsummering: projectFromCms?.oppsummering,
    // squareFootage: projectFromCms?.squareFootage,
    // publisert: projectFromCms?.publisert,
    // assignmentType: projectFromCms?.assignmentType,
  });
}
---

<script>
  import type { Project } from '@/lib/types';
  import { sanityClient } from 'sanity:client';

  let projects: Project[] = await sanityClient.fetch(
    `*[_type == "project"]{
    'slug': slug.current, 
    title, 
    authors,
    oppsummering,
    squareFootage,
    publisert,
    assignmentType
  }`
  );
</script>

<Layout projects={projects}>
  <Gallery images={images} />
</Layout>
